---
title: "Introduction to the waterquality package"
author: "Richard Johansen, Jakub Nowosad, Molly Reif, and Erich Emery"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to the waterquality package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE)
```

The main purpose of **waterquality** is to quickly and easily convert satellite-based reflectance imagery into one or many well-known water quality algorithms designed for the detection of harmful algal blooms or the following pigment proxies: chlorophyll-a, blue-green algae (Phycocyanin), and Turbidity. Currently, this package is able to process [45 algorithms](https://rajohansen.github.io/waterquality/reference/index.html) for the following satellite-based imagers: WorldView-2, Sentinel-2, Landsat-8, MODIS, MERIS, and OLCI. In order to improve the aesthetics of the `wq_calc` output, we are developing a series of `Map_WQ` functions which may reduce technical barriers and simplify the complexities in selecting a map layout. Additional functionality of the package include a series of `extract_lm` functions wrap that ["Fitting Linear Models"](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/lm) and the ["caret"](http://topepo.github.io/caret/index.html) packages to quickly generate crossvalidated linear model and standardized outputs (r^2, p-value, slope, intercept of the global lm model & average r^2, average RMSE, average MAE of crossvalidated model) for any number of algorithm and water quality parameters combinations. It is important to note that the `extract_lm` functions require ground-truth data in order to develop the models. 

For an example of a full research workflow, including data acquisition, image pre-processing, methods, and results please see our publication entitled["Waterquality: An Open-Source R Package for the Detection and Quantification of Cyanobacterial Harmful Algal Blooms and Water Quality"](https://erdc-library.erdc.dren.mil/jspui/bitstream/11681/35053/3/ERDC-EL%20TR-19-20.pdf). 

## Algorithms

Currently, we have a list of [45 algorithms](https://rajohansen.github.io/waterquality/reference/index.html) that can be applied for the detection of these three metrics. 
Although, it is important to note that not all sensors are capable of using all algorithms due to their spectral configurations. 
Each of the algorithms are searchable within the package, where there is a reference to the original paper (Ex. `?Am092Bsub()`). 
Each algorithm is also linked to the original papers metric (chlorophyll-a, phycocyanin, Turbidity) by type, which allows users to select all algorithms for that type.
The final raster images are in relative index values and are not the estimated chlorophyll-a, phycocyanin, or turbidity values. However, these relative values can be converted in to estimated concentration values using the `extract_lm` functions and ground truth measurements. 


## Water Quality Functions 

### wq_calc()

The main function of this package is called `wq_calc()` which calculates water quality indices by using an reflectance raster stack as an input, user-defined algorithm(s) selection, and satellite configuration selection corresponding to the following three arguments: `raster_stack`, `alg`, and `sat`.

- `raster_stack` - The input reflectance image to be used in band algorithm calculation. 
- `alg` - Determines the indices to be utilized:
    - Single Algorithm
    - Multiple Algorithm
    - Type of Algorithm
    - All Possible Algorithms
- `sat` - Determines the appropriate spectral configuration and subsequently appropriate algorithms to be calculated from predefined list:
    - WorldView-2
    - Sentinel-2
    - Landsat-8
    - MODIS
    - MERIS
    - OLCI


### Examples

```{r, results='hide', message=FALSE, warning=FALSE}
library(waterquality)
library(raster)
Harsha <- stack(system.file("raster/S2_Harsha.tif", package = "waterquality"))
```

#### Single Algorithm

```{r,results='hide', message=FALSE, warning=FALSE}
Harsha_Am092Bsub <- wq_calc(raster_stack = Harsha, 
                            alg = "Am092Bsub", 
                            sat = "sentinel2")
```
```{r, fig.height = 4, fig.width = 4}
plot(Harsha_Am092Bsub)
```


#### Multiple Algorithms

```{r,results='hide', message=FALSE, warning=FALSE}
Harsha_Multiple <- wq_calc(raster_stack = Harsha,
                           alg = c("Am092Bsub", "Go04MCI", "Da052BDA"), 
                           sat = "sentinel2")
```
```{r, fig.height = 5, fig.width = 6}
plot(Harsha_Multiple) 
```


#### Type of Algorithm

```{r,results='hide', message=FALSE, warning=FALSE}
Harsha_PC <- wq_calc(Harsha,
                     alg = "phycocyanin", 
                     sat = "sentinel2")
```
```{r, fig.height = 5, fig.width = 6}
plot(Harsha_PC) 
```
 
 
#### All Algorithms

```{r, results='hide', message=FALSE, warning=FALSE}
Harsha_All <- wq_calc(Harsha, 
                      alg = "all",
                      sat = "sentinel2")
```
```{r,fig.height = 5, fig.width = 6}
plot(Harsha_All) # Only displays first 12 of 28
```


## Mapping Functions

### Map_WQ_raster
This function wraps the ["tmap"](https://cran.r-project.org/web/packages/tmap/tmap.pdf) package to help users generate an efficient map of their `wq_calc()` raster output along with optional geospatial objects and histogram. In order to simplify this process and reduce the technical expertise required, we have reduced the number of arguments to the following: 

- `WQ_raster` - Raster file generated from `wq_calc` or other GeoTiff file	
- `sample_points` - geospatial file (.shp or .gpkg) containing sampling locations 
- `map_title` - text used to generate title of map
- `raster_style` - method to process the color scale when col is a numeric variable. Please refer to the style argument in the ?tmap::tm_raster() function for more details (Default is "quantile").
- `histogram` - Option to add or remove a histogram of the data values. (Default is TRUE)

#### Example  

```{r, results='hide', message=FALSE, warning=FALSE}
library(waterquality)
library(raster)
library(tmap)
library(sf)
s2 = stack(system.file("raster/S2_Harsha.tif", package = "waterquality"))
MM12NDCI = wq_calc(s2, alg = "MM12NDCI", sat = "sentinel2")
samples = st_read(system.file("raster/Harsha_Simple_Points_CRS.gpkg", package = "waterquality"))
lake_extent = st_read(system.file("raster/Harsha_Lake_CRS.gpkg", package = "waterquality"))
```

```{r,fig.height = 5, fig.width = 6}
Map_WQ_raster(WQ_raster = MM12NDCI,
              sample_points = samples,
              map_title= "Water Quality Map",
              raster_style = "quantile",
              histogram = TRUE)

```


### Map_WQ_basemap
This function wraps the ["tmap"](https://cran.r-project.org/web/packages/tmap/tmap.pdf) & ["tmaptools"](https://cran.r-project.org/web/packages/tmaptools/tmaptools.pdf) packages in order to generate a map using user-defined vectors (points and a polygon) overlaid on a Bing basemap. In order to simplify this process and reduce the technical expertise required, we have reduced the number of arguments to the following: 

- `WQ_extent` - geospatial file (.shp or .gpkg) used to extract aerial imagery from Bing basemaps	
- `WQ_parameter` - text referring to column heading of data being mapped (i.e. Chl-a, PC, etc.)
- `sample_points` - geospatial file (.shp or .gpkg) containing sampling locations
- `map_title` - text used to generate title of map
- `points_style` - method to process the color scale when col is a numeric variable. Please refer to the style argument in the ?tmap::tm_raster() function for more details (Default = "quantile").
- `histogram` - Option to add or remove a histogram of the data values. (Default = TRUE)

#### Example  

```{r,fig.height = 5, fig.width = 6}
Map_WQ_basemap(WQ_extent = lake_extent,
              sample_points = samples,
              WQ_parameter = "Chl_ugL",
              map_title= "Water Quality Map",
              points_style = "quantile",
              histogram = TRUE)

```


## Modeling Functions
After a user has generated raster stack image of their desired water quality algorithms using `wq_calc`, they can create linear models assuming they have coincident in situ data. These functions have been designed to easily conduct linear models and produce standardized outputs. These functions are designed to most effectively work with comma deliminated (.csv) files as the data frame and column names ("text") as the inputs for the `parameter` and `algorithm` arguments. Although these functions were designed for our water quality research, they can be used as standalone functions to generate standardized outputs for the following: 

**Global Model**
  -r^2 
  -p-value
  -slope
  -intercept
**Crossvalidated Model**
  -lm model
  -average r^2 
  -average RMSE
  -average MAE

Additionally we have provided code that might be useful to import raster and shapefile objects, extract the data from a raster stack image (i.e. output from `wq_calc`) and combine it with a geospatial object (i.e shapefiles of sampling locations), and export the results to a .csv file to be used in the modeling functions. 

```{r, eval = FALSE}
#Input raster image
wq_raster <- stack("C:/temp/my_raster.tif")

#Input shapefile
wq_samples <- shapefile('C:/temp/my_samples.shp')

#Extract values from raster and combine with shapefile
waterquality_data <- data.frame(wq_samples, extract(wq_raster, wq_samples))

#Export results as csv file
write.csv(waterquality_data, file = "C:/temp/waterquality_data.csv")
```


### extract_lm

- `parameter` A string specifying water quality parameter
- `algorithm` A string specifying water quality algorithm
- `df` data frame containing the values for parameter and algorithm arguments

#### Example

```{r, results='hide', message=FALSE, warning=FALSE}
library(waterquality)
library(caret)
df <- read.csv(system.file("raster/waterquality_data.csv", package = "waterquality"))
```
```{r}
extract_lm(parameter = "Chl_ugL", algorithm = "MM12NDCI", df = df)
```


### extract_lm_cv

- `parameter` A string specifying water quality parameter
- `algorithm` A string specifying water quality algorithm
- `df` data frame containing the values for parameter and algorithm arguments
- `train_method` A string specifying which classification or regression model to use (Default = "lm"). See ?caret::train for more details
- `control_method` A string specifying the resampling method (Default = "repeatedcv"). See ?caret::trainControl for more details
- `folds` the number of folds to be used in the cross validation model (Default = 3)
- `nrepeats` the number of iterations to be used in the cross validation model (Default = 5)

#### Example

```{r}
extract_lm_cv(parameter = "Chl_ugL", algorithm = "MM12NDCI",
                                       df = df, train_method = "lm", control_method = "repeatedcv",
                                       folds = 3, nrepeats = 5)
```


### extract_lm_cv_multi

- `parameters` list of water quality parameters
- `algorithms` list of water quality algorithms
- `df` data frame containing the values for parameter and algorithm arguments
- `train_method` A string specifying which classification or regression model to use (Default = "lm"). See ?caret::train for more details
- `control_method` A string specifying the resampling method (Default = "repeatedcv"). See ?caret::trainControl for more details
- `folds` the number of folds to be used in the cross validation model (Default = 3)
- `nrepeats` the number of iterations to be used in the cross validation model (Default = 5)

#### Example

```{r}
# Create series of strings to be used for parameters and algorithms arguments
algorithms <- c(names(df[6:10]))
parameters <- c(names(df[3:5]))
extract_lm_cv_multi_results <- extract_lm_cv_multi(parameters = parameters, algorithms = algorithms,
                                                   df = df, train_method = "lm", control_method = "repeatedcv",
                                                   folds = 3, nrepeats = 5)
dplyr::arrange(extract_lm_cv_multi_results,desc("R_Squared"))
```


### extract_lm_cv_all 

- `parameters` list of water quality parameters
- `df` data frame containing the values for parameter and algorithm arguments
- `train_method` A string specifying which classification or regression model to use (Default = "lm"). See ?caret::train for more details
- `control_method` A string specifying the resampling method (Default = "repeatedcv"). See ?caret::trainControl for more details
- `folds` the number of folds to be used in the cross validation model (Default = 3)
- `nrepeats` the number of iterations to be used in the cross validation model (Default = 5)

#### Example

```{r}
extract_lm_cv_all_results <- extract_lm_cv_multi(parameters = parameters, df = df,
                                                 train_method = "lm", control_method = "repeatedcv",
                                                 folds = 3, nrepeats = 5)
dplyr::arrange(extract_lm_cv_all_results,desc("R_Squared"))
```


## Acknowledgements

The waterquality package was developed with funding from the U.S. Army Corps of Engineers.
The authors would also like to thank the University of Cincinnati Library's Research & Data Services and the University of Cincinnati's Space Informatics Lab for their expertise and technical services. 


## Credit

To cite this library, please use the following entry:

Johansen R., Reif M., Emery E., Nowosad J., Beck R., Xu M., Liu H., waterquality: An Open-Source R Package for the Detection and Quantification of Cyanobacterial Harmful Algal Blooms and Water Quality.
  USACE ERDC/EL TR-19-20; DOI: 10.21079/11681/35053

@Article{,
  author = {Richard Johansen and Molly Reif and Erich Emery and Jakub Nowosad and Richard Beck and Min Xu and Hongxing Liu},
  title = {waterquality: An Open-Source R Package for the Detection and Quantification of Cyanobacterial Harmful Algal Blooms and Water Quality},
  year = {2019},
  doi = {10.21079/11681/35053},
  journal = {USACE ERDC/EL TR-19-20},
}
