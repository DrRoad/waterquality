---
title: "Introduction to the waterquality package"
author: "Richard Johansen, Jakub Nowosad, Molly Reif, and Erich Emery"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to the waterquality package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE)
```

The main purpose of **waterquality** is to quickly and easily convert satellite-based reflectance imagery into one or many well-known water quality algorithms designed for the detection of harmful algal blooms or the following pigment proxies: chlorophyll-a, blue-green algae (Phycocyanin), and Turbidity. Currently, this package is able to process [45 algorithms](https://rajohansen.github.io/waterquality/reference/index.html) for the following satellite-based imagers: WorldView-2, Sentinel-2, Landsat-8, MODIS, MERIS, and OLCI. In order to improve the aesthetics of the `wq_calc` output, we are developing a series of `Map_WQ` functions which may reduce technical barriers and simplify the complexities in selecting a map layout. Additional functionality of the package include a series of `extract_lm` functions wrap that ["Fitting Linear Models"](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/lm) and the ["caret"](http://topepo.github.io/caret/index.html) packages to quickly generate crossvalidated linear model and standardized outputs (r^2, p-value, slope, intercept of the global lm model & average r^2, average RMSE, average MAE of crossvalidated model) for any number of algorithm and water quality parameters combinations. It is important to note that the `extract_lm` functions require ground-truth data in order to develop the models. 

For an example of a full research workflow, including data acquisition, image pre-processing, methods, and results please see our publication entitled["Waterquality: An Open-Source R Package for the Detection and Quantification of Cyanobacterial Harmful Algal Blooms and Water Quality"](https://erdc-library.erdc.dren.mil/jspui/bitstream/11681/35053/3/ERDC-EL%20TR-19-20.pdf). 

## Algorithms

Currently, we have a list of [45 algorithms](https://rajohansen.github.io/waterquality/reference/index.html) that can be applied for the detection of these three metrics. 
Although, it is important to note that not all sensors are capable of using all algorithms due to their spectral configurations. 
Each of the algorithms are searchable within the package, where there is a reference to the original paper (Ex. `?Am092Bsub()`). 
Each algorithm is also linked to the original papers metric (chlorophyll-a, phycocyanin, Turbidity) by type, which allows users to select all algorithms for that type.
The final raster images are in relative index values and are not the estimated chlorophyll-a, phycocyanin, or turbidity values. However, these relative values can be converted in to estimated concentration values using the `extract_lm` functions and ground truth measurements. 


## Functions 

### wq_calc()

The main function of this package is called `wq_calc()` which calculates water quality indices by using an reflectance raster stack as an input, user-defined algorithm(s) selection, and satellite configuration selection corresponding to the following three variables: `raster_stack`, `alg`, and `sat`.

- `raster_stack` - The input reflectance image to be used in band algorithm calculation. 
- `alg` - Determines the indices to be utilized:
    - Single Algorithm
    - Multiple Algorithm
    - Type of Algorithm
    - All Possible Algorithms
- `sat` - Determines the appropriate spectral configuration and subsequently appropriate algorithms to be calculated from predefined list:
    - WorldView-2
    - Sentinel-2
    - Landsat-8
    - MODIS
    - MERIS
    - OLCI


### Examples

```{r, results='hide', message=FALSE, warning=FALSE}
library(waterquality)
library(raster)
Harsha <- stack(system.file("raster/S2_Harsha.tif", package = "waterquality"))
```

#### Single Algorithm

```{r,results='hide', message=FALSE, warning=FALSE}
Harsha_Am092Bsub <- wq_calc(raster_stack = Harsha, 
                            alg = "Am092Bsub", 
                            sat = "sentinel2")
```
```{r, fig.height = 4, fig.width = 4}
plot(Harsha_Am092Bsub)
```


#### Multiple Algorithms

```{r,results='hide', message=FALSE, warning=FALSE}
Harsha_Multiple <- wq_calc(raster_stack = Harsha,
                           alg = c("Am092Bsub", "Go04MCI", "Da052BDA"), 
                           sat = "sentinel2")
```
```{r, fig.height = 5, fig.width = 6}
plot(Harsha_Multiple) 
```


#### Type of Algorithm

```{r,results='hide', message=FALSE, warning=FALSE}
Harsha_PC <- wq_calc(Harsha,
                     alg = "phycocyanin", 
                     sat = "sentinel2")
```
```{r, fig.height = 5, fig.width = 6}
plot(Harsha_PC) 
```
 
 
#### All Algorithms

```{r, results='hide', message=FALSE, warning=FALSE}
Harsha_All <- wq_calc(Harsha, 
                      alg = "all",
                      sat = "sentinel2")
```
```{r,fig.height = 5, fig.width = 6}
plot(Harsha_All) # Only displays first 12 of 28
```


### Map_WQ Functions

### Examples

#### Map_WQ_Raster
```{r, results='hide', message=FALSE, warning=FALSE}
library(waterquality)
library(raster)
library(tmap)
library(sf)
s2 = stack(system.file("raster/S2_Harsha.tif", package = "waterquality"))
MM12NDCI = wq_calc(s2, alg = "MM12NDCI", sat = "sentinel2")
samples = st_read(system.file("raster/Harsha_Simple_Points_CRS.gpkg", package = "waterquality"))
lake_extent = st_read(system.file("raster/Harsha_Lake_CRS.gpkg", package = "waterquality"))
```

```{r,fig.height = 5, fig.width = 6}
Map_WQ_raster(WQ_raster = MM12NDCI,
              sample_points = samples,
              map_title= "Water Quality Map",
              raster_style = "quantile",
              histogram = TRUE)

```
  

## Acknowledgements

The waterquality package was developed with funding from the U.S. Army Corps of Engineers.
The authors would also like to thank the University of Cincinnati Library's Research & Data Services and the University of Cincinnati's Space Informatics Lab for their expertise and technical services. 


## Credit

To cite this library, please use the following entry:

Johansen R., Reif M., Emery E., Nowosad J., Beck R., Xu M., Liu H., waterquality: An Open-Source R Package for the Detection and Quantification of Cyanobacterial Harmful Algal Blooms and Water Quality.
  USACE ERDC/EL TR-19-20; DOI: 10.21079/11681/35053

@Article{,
  author = {Richard Johansen and Molly Reif and Erich Emery and Jakub Nowosad and Richard Beck and Min Xu and Hongxing Liu},
  title = {waterquality: An Open-Source R Package for the Detection and Quantification of Cyanobacterial Harmful Algal Blooms and Water Quality},
  year = {2019},
  doi = {10.21079/11681/35053},
  journal = {USACE ERDC/EL TR-19-20},
}
